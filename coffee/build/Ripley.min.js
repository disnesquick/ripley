var headers;headers={HEADER_HUP:"\x00",HEADER_RESOLVE:"",HEADER_NOTIFY:"",HEADER_EVAL:"",HEADER_NOTIFY_TRANS:"",HEADER_EVAL_TRANS:"",HEADER_REPLY:"",HEADER_MESSAGE_ERROR:"",HEADER_GENERAL_ERROR:"",HEADER_TIME:"",HEADER_FILTER_IN:"",HEADER_FILTER_OUT:"",HEADER_FILTER_ERR:"",HEADER_DEREF:""};var Connection;Connection=function(){function a(a,b){this.objectToObjectID={},this.objectIDToObject={},this.sharedCount=-1,this.services=[],this.proxyTokens={},this.bus=a,this.connectionID=b,this.cachedTransverse={}}return a.prototype.generateObjectID=function(){return this.objectCount+=1,SerialID.integerToBytes(this.objectCount)},a.prototype.objectToReference=function(a){var b;return a(isinstance(ProxyObject))?a.reference:a in this.objectToObjectID?(b=this.objectToObjectID[a],[this.connectionID,b]):(b=this.generateObjectID(),this.objectIDToObject[b]=a,this.objectToObjectID[a]=b,[this.connectionID,b])},a.prototype.referenceToObject=function(a,b){var c,d,e,f,g;if(c=a[0],g=a[1],c===this.connectionID){if(!(g in this.objectIDToObject))throw new UnknownObjectIDError(g);if(f=this.objectIDToObject[g],!f(isinstance(b)))throw new ReferenceTypeMismatchError(f,b)}else{try{d=this.proxyTokens[c]}catch(h){throw e=h,new RouteNotFound(this.connectionID,c,a,b)}f=new(b.getProxyClass())(d,a)}return f},a.prototype.serializeObjects=function(a,b,c){var d,e,f,g;for(d=f=0,g=a.length;g>f;d=++f)e=a[d],this.serializeObject(e,typ[d],c)},a.prototype.serializeObject=function(a,b,c){var d;b(isinstance(PassByValue))?b(isinstance(ComplexPassByValue))?b.serialize(a,this,c):b.serialize(a,c):(d=this.objectToReference(a),Reference.serialize(d,c))},a.prototype.deserializeObjects=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(this.deserializeObject(c,b));return f},a.prototype.deserializeObject=function(a,b){var c;return a(isinstance(PassByValue))?a(isinstance(ComplexPassByValue))?a.deserialize(this,b):a.deserialize(b):(c=Reference.deserialize(b),this.referenceToObject(c,a))},a.prototype.addTransverseMap=function(a){this.transverseMaps.append(a)},a.prototype.transverseIDToReference=function(a){var b,c;for(c in this.transverseMaps)if(a in c)return b=c[a],this.objectToReference(b);throw new UnknownTransverseIDError(a)},a.prototype.handleReceived=function(a,b){var c;if(c=b.read(1),c===headers.HEADER_RESOLVE)this.receiveResolve(a,b);else if(c===headers.HEADER_NOTIFY)this.receiveNotify(a,b);else if(c===headers.HEADER_EVAL)this.receiveEval(a,b);else if(c===headers.HEADER_REPLY)this.receiveReply(a,b);else if(c===headers.HEADER_MESSAGE_ERROR)this.receiveMessageError(a,b);else if(c===headers.HEADER_GENERAL_ERROR)this.receiveGeneralError(a,b);else if(c===headers.HEADER_FILTER_IN)this.modifyIOFilterInput(a,b);else{if(c!==headers.HEADER_FILTER_OUT)throw new DecodingError("Unrecognized header %s"%c);this.modifyIOFilterOutput(a,b)}},a.prototype.receiveResolve=function(a,b){var c,d,e,f,g;c=MessageID.deserialize(b);try{g=TransverseID.deserialize(b),e=this.transverseIDToReference(g),d=a.getOutputBuffer(),d.write(headers.HEADER_REPLY),MessageID.serialize(c,d),Reference.serialize(e,d),d.commit()}catch(h){f=h,this.handleIncomingMessageError(a,c,f)}},a.prototype.receiveNotify=function(a,b){var c;c=this.deserializeObject(ExposedCallable,b),c.handleNotification(this,b)},a.prototype.receiveEval=function(a,b){var c,d,e,f;d=MessageID.deserialize(b);try{c=this.deserializeObject(ExposedCallable,b),e=a.getOutputBuffer(),e.write(headers.HEADER_REPLY),MessageID.serialize(d,e),c.handleEval(this,b,e),e.commit()}catch(g){f=g,this.handleIncomingMessageError(a,d,f)}},a.prototype.receiveReply=function(a,b){var c,d,e,f;d=MessageID.deserialize(b),f=this.bus.resolveMessageID(d,a.lastRoute),c=f[0],e=f[1],c(b)},def({receiveMessageError:function(a,b){var c,d,e,f,g,h,i;e=MessageID.deserialize(b),i=self.bus.resolveMessageID(e,a.lastRoute),h=i[0],c=i[1],g=TransverseID.deserialize(b);try{return f=this.transverseIDToObject(g),d=f.handleFetch(this,b),c(d)}catch(j){return c(new ErrorUnsupported(g))}}}),a.prototype.receiveGeneralError=function(a,b){var c,d,e;e=TransverseID.deserialize(b);try{d=this.transverseIDToObject(e),c=d.handleFetch(this,b),error(c)}catch(f){error(new ErrorUnsupported(e))}return this.bus.handleGeneralError(a,c)},a.prototype.modifyIOFilterInput=function(a,b){var c,d;c=this.deserializeObject(FilterElement,b),d=new StringIO,c.transcode(b,d),d.seek(0),this.handleReceived(a,d)},a.prototype.modifyIOFilterOutput=function(a,b){var c,d,e;c=this.deserializeObject(FilterElement,b),d=Reference.deserialize(b),e=FilteredResponseRoute(a,c,d),this.handleReceived(e,b)},a.prototype.transceiveResolve=function(a,b){return new Promise(function(c,d){var e,f,g,h;return e=[a.transport.remoteBusID,b],e in this.cachedTransverse?c(this.cachedTransverse[e]):(h=function(a){var b,f;try{return f=Reference.deserialize(a),this.cachedTransverse[e]=f,c(f)}catch(g){return b=g,d(b)}},f=this.bus.waitForReply(h,fut.setError,a.lastRoute),g=a.getOutputBuffer(),g.write(headers.HEADER_RESOLVE),MessageID.serialize(f,g),TransverseID.serialize(b,g),g.commit())})},a.prototype.transmitNotify=function(a,b){var c;return c=a.getOutputBuffer(),c.write(headers.HEADER_NOTIFY),Reference.serialize(b,c),c},a.prototype.transceiveEval=function(a,b){var c,d;return d=a.getOutputBuffer(),c=new Promise(function(c,e){var f;return f=this.bus.waitForReply(c,e,a.lastRoute),d.write(headers.HEADER_EVAL),MessageID.serialize(f,d),Reference.serialize(b,d)}),[d,c]},a.prototype.transmitMessageError=function(a,b,c){var d;return d=a.getOutputBuffer(),d.write(headers.HEADER_MESSAGE_ERROR),MessageID.serialize(b,d),c.serializeConstructor(this,d),d.commit()},a.prototype.transmitGeneralError=function(a,b){var c;return c=a.getOutputBuffer(),c.write(headers.HEADER_GENERAL_ERROR),b.serializeConstructor(this,c),c.commit()},a.prototype.handleIncomingMessageError=function(a,b,c){return c(isinstance(TransverseException))?this.transmitMessageError(a,b,c):this.bus.handleLocalException(a,c)},a}();var Bus,TimeoutError,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};TimeoutError=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(Error),Bus=function(){function a(){var a,b,c;for(this.messageCount=-1,this.messageQueues=[],b=c=0;0<=mqLen?c<=mqLen:c>=mqLen;b=0<=mqLen?++c:--c)this.messageQueues.push({});a=this.messageQueuesTick.bind(this),this.messageQueueWatchdog=setInterval(a,tickLen)}return a.prototype.messageQueuesTick=function(){var a,b,c,d,e;this.messageQueues.unshift({}),b=this.messageQueues.pop(),e=[];for(d in b)a=b[d],c=a[1],e.push(c(new TimeoutError));return e},a.prototype.waitForReply=function(a,b,c){var d,e;return this.messageCount+=1,d=SerialID.integerToBytes(this.messageCount),e=this.messageQueues[0],e[d]=[a,b,c],d},a.prototype.resolveMessageID=function(a,b){var c,d,e,f,g;for(g=this.messageQueues,e=0,f=g.length;f>e;e++)if(c=g[e],a in c){if(d=c[a],d[2]!==b)throw new UnknownMessageIDError(a);return c.pop(a),d.pop(),d}throw new UnknownMessageIDError(a)},a.prototype.getBootstrapConnection=function(a){var b,c,d;return b=new OpenRoute,d=b.supplyTransport(a),(c=function(c){return function(){var e,f;return e=null,f=null,a.bootstrap(d).then(function(a){var d,g,h,i,j;return i=a[0],d=a[1],g=a[2],f=a[3],e=new Connection(c,d),b.supplyConnection(e),b.completeRoute(i,g),h=b.route,j=new BusMasterService(h),j.getBusMaster(void 0)}).then(function(a){return e.addTransverseMap(busClientService.exposedTransverse),e.addTransverseMap(basicErrorService.exposedTransverse),[e,a,f]})}}(this))()},a.prototype.connection=function(){var a,b;return a=this.masterService.getNeonateID(),b=new Connection(this,a),b.addTransverseMap(basicErrorService.exposedTransverse),b},a.prototype.reportDestinationFailure=function(a){return a.transport.unregisterRoute(a)},a}();var FullBus,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};FullBus=function(a){function b(a,c){b.__super__.constructor.call(this,a,c),this.transports={},this.transportCount=-1}return __extends(b,a),b.prototype.engageBus=function(a,b){var c;return null==b&&(b=!1),this.busID=a,b?void 0:(c=LoopbackTransport(),c.engageTransport(a),this.registerTransport(a,c))},b.prototype.registerTransport=function(a,b){return this.transports[a]=Promise.resolve(b)},b.prototype.resolveTransport=function(a){var b,c;return c=!a,__indexOf.call(this.transports,c)>=0?(b=new OpenTransport,this.masterService.requestConnection(b,a),b.transportPromise.then(function(b){return this.registerTransport(a,b),b.engageTransport(a)})):this.transports[a]},b.prototype.registerServer=function(a,b){return null==b&&(b=a.connectionURI),this.masterService.registerServer(a,b)},b}(Bus);var SingleBus,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};SingleBus=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.bootstrapOnTransport=function(a){var b,c,d,e;return e=this.getBootstrapConnection(a),b=e[0],c=e[1],d=e[2],this.masterService=c,this.onlyTransport=a,b},b.prototype.resolveTransport=function(a){var b;if(b=this.onlyTransport.remoteBusID,a!==b)throw new KeyError("Remote bus was not the right bus. Saw "+a,"it should be "+b);return this.onlyTransport},b}(Bus);